<div class="complaint-management-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="department-info">
        <h1><i class="fas fa-building me-2"></i>{{ departmentName || 'Department' }}</h1>
        <p class="department-subtitle">Complaint Management Dashboard</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline-light" (click)="refreshData()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-outline-light" (click)="exportToCSV()">
          <i class="fas fa-download"></i> Export
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading-spinner" *ngIf="loading">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading dashboard...</span>
  </div>

  <!-- Stats Dashboard -->
  <div class="stats-dashboard" *ngIf="departments && !loading">
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon total">
          <i class="fas fa-clipboard-list"></i>
        </div>
      </div>
      <div class="stat-number">{{ departments.totalComplaints || 0 }}</div>
      <div class="stat-label">Total Complaints</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon pending">
          <i class="fas fa-clock"></i>
        </div>
      </div>
      <div class="stat-number">{{ departments.pendingComplaints || 0 }}</div>
      <div class="stat-label">Pending</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon assigned">
          <i class="fas fa-user-check"></i>
        </div>
      </div>
      <div class="stat-number">{{ departments.assignedComplaints || 0 }}</div>
      <div class="stat-label">Assigned</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon resolved">
          <i class="fas fa-check-circle"></i>
        </div>
      </div>
      <div class="stat-number">{{ departments.resolvedComplaints || 0 }}</div>
      <div class="stat-label">Resolved</div>
    </div>

    <div class="stat-card" *ngIf="departments.overdueComplaints > 0">
      <div class="stat-header">
        <div class="stat-icon overdue">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
      <div class="stat-number">{{ departments.overdueComplaints || 0 }}</div>
      <div class="stat-label">Overdue</div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section" *ngIf="!loading">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="statusFilter">Status</label>
        <select id="statusFilter" [(ngModel)]="statusFilter" class="filter-select">
          <option value="All">All Status</option>
          <option value="Pending">Pending</option>
          <option value="Assigned">Assigned</option>
          <option value="InProgress">In Progress</option>
          <option value="Resolved">Resolved</option>
          <option value="Reopened">Reopened</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="priorityFilter">Priority</label>
        <select id="priorityFilter" [(ngModel)]="priorityFilter" class="filter-select">
          <option value="All">All Priority</option>
          <option value="High">High (Overdue)</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
      
      <div class="filter-group search-group">
        <label for="searchTerm">Search</label>
        <input 
          id="searchTerm" 
          type="text" 
          [(ngModel)]="searchTerm" 
          placeholder="Search by ticket number, citizen name, or description..."
          class="search-input">
      </div>
    </div>
  </div>

  <!-- Complaints Table -->
  <div class="table-section" *ngIf="!loading">
    <div class="table-header">
      <h3>Complaints Overview</h3>
    </div>
    
    <div class="table-container">
      <table class="complaints-table">
        <thead>
          <tr>
            <th class="text-center">Ticket No</th>
            <th class="text-center">Citizen</th>
            <th class="text-center">Category</th>
            <th class="text-center">Description</th>
            <th class="text-center">Priority</th>
            <th class="text-center">Status</th>
            <th class="text-center">Created</th>
            <th class="text-center">SLA Due</th>
            <th class="text-center">Assigned Worker</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let complaint of paginatedComplaints">
            <td class="text-center">
              <span class="ticket-no">{{ complaint.ticketNo }}</span>
              <span class="priority-indicator" 
                    [class]="getPriorityClass(complaint.priority!)"
                    *ngIf="complaint.isOverdue && complaint.currentStatus != 'Resolved' && complaint.currentStatus != 'Closed'">
                <i class="fas fa-exclamation-triangle"></i>
              </span>
            </td>
            <td class="text-center">{{ complaint.citizenName }}</td>
            <td class="text-center">
              <div class="category-info">
                <div class="category">{{ complaint.categoryName }}</div>
                <div class="subcategory">{{ complaint.subCategoryName }}</div>
              </div>
            </td>
            <td class="text-center description-cell">
              <span class="description-text" [title]="complaint.description">
                {{ complaint.description.length > 50 ? complaint.description.substring(0, 50) + '...' : complaint.description }}
              </span>
            </td>
            <td class="text-center">
              <span class="fw-bold fs-6" *ngIf="complaint.currentStatus == 'Resolved' || complaint.currentStatus == 'Closed'">
                N/A
              </span>
              <span *ngIf="complaint.currentStatus != 'Resolved' && complaint.currentStatus != 'Closed'" class="priority-badge" [class]="getPriorityClass(complaint.priority!)">
                {{ complaint.priority }}
              </span>
            </td>
            <td class="text-center">
              <span class="status-badge" [class]="getStatusClass(complaint.currentStatus)">
                {{ complaint.currentStatus }}
              </span>
            </td>
            <td class="text-center">{{ complaint.createdAt | date:'short' }}</td>
            <td class="text-center" [class.overdue]="complaint.isOverdue">
              {{ complaint.slaDueAt | date:'short' }}
            </td>
            <td class="text-center">
              <span *ngIf="complaint.assignedWorkerName; else notAssigned">
                {{ complaint.assignedWorkerName }}
              </span>
              <ng-template #notAssigned>
                <span class="not-assigned">Not Assigned</span>
              </ng-template>
            </td>
            <td class="text-center">
              <div class="action-buttons">
                <button class="btn btn-sm btn-success" 
                        (click)="openAssignModal(complaint.complaintId)"
                        *ngIf="complaint.currentStatus === 'Pending'"
                        title="Assign Worker">
                  <i class="fas fa-user-plus"></i>
                </button>
                <button class="btn btn-sm btn-danger" 
                        (click)="opendeleteComplaintModal(complaint.complaintId)"
                        title="Delete Complaint">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      
      <!-- No data message -->
      <div class="no-data" *ngIf="filteredComplaints.length === 0">
        <i class="fas fa-inbox"></i>
        <p>No complaints found matching your criteria.</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="btn btn-sm" 
              (click)="changePage(currentPage - 1)" 
              [disabled]="currentPage === 1">
        <i class="fas fa-chevron-left"></i>
      </button>
      
      <span class="page-info">
        Page {{ currentPage }} of {{ totalPages }}
      </span>
      
      <button class="btn btn-sm" 
              (click)="changePage(currentPage + 1)" 
              [disabled]="currentPage === totalPages">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Assignment Modal -->
  <div class="modal-overlay" *ngIf="showAssignModal" (click)="closeAssignModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h4>Assign Complaint to Worker</h4>
        <button class="close-btn" (click)="closeAssignModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="workerSelect">Select Worker:</label>
          <select id="workerSelect" [(ngModel)]="selectedWorkerId" class="form-select">
            <option selected disabled class="text-muted" value="">-- Select a Worker --</option>
            <option *ngFor="let worker of availableWorkers" 
                    [value]="worker.workerId">
              {{ worker.fullName }} ({{ worker.currentAssignments }} assignments)
            </option>
          </select>
        </div>
        
        <div class="workers-list">
          <h5>Available Workers:</h5>
          <div class="worker-item" *ngFor="let worker of availableWorkers">
            <span class="worker-name">{{ worker.fullName }}</span>
            <span class="worker-load">Current: {{ worker.currentAssignments }} assignments</span>
            <span class="worker-status" [class.active]="worker.isActive">
              {{ worker.isActive ? 'Active' : 'Inactive' }}
            </span>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAssignModal()">Cancel</button>
        <button class="btn btn-primary" 
                (click)="assignComplaint()" 
                [disabled]="!selectedWorkerId">
          Assign Complaint
        </button>
      </div>
    </div>
  </div>

  <!--Confirm delete modal-->
  <div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'"
     tabindex="-1" *ngIf="showDeleteModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 20px; border: none;">
        
        <div class="modal-header bg-danger text-white" style="border-radius: 20px 20px 0 0;">
          <h5 class="modal-title">
            <i class="fas fa-trash-alt me-2"></i>
            Confirm Delete
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeDeleteModal()"></button>
        </div>
        
        <div class="modal-body text-center p-4">
          <div class="mb-3">
            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
          </div>
          <h5 class="fw-bold text-danger mb-2">Are you sure?</h5>
          <p class="text-muted mb-0">
            This action <strong>cannot be undone</strong>.  
            Do you really want to delete this complaint?
          </p>
        </div>
        
        <div class="modal-footer border-0 p-4 d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" (click)="closeDeleteModal()">
            <i class="fas fa-times me-1"></i>
            Cancel
          </button>
          <button type="button" class="btn btn-danger" (click)="confirmDeleteComplaint()">
            <i class="fas fa-trash me-2"></i>
            Delete
          </button>
        </div>      
      </div>
    </div>
  </div>

</div>